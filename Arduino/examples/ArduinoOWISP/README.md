# Arduino as ISP over 1-wire

This code is a modified version of ArduinoISP derived from Arduino IDE examples.
ArduinoOWISP utilizes SPI over 1-wire tunnel to turn your Arduino into a
remote in-circuit programmer for AVR chips.

## How to use

1. Make connections:  
   ![SPI over 1-wire](https://github.com/honechko/DS2450/raw/main/Arduino/examples/SPI_advanced/spi.jpg)  
   Left Arduino is named _local_ and functionally is a _programmer_, connect it to host with USB-cable.
   Right Arduino is named _remote_ and functionally is a _target_.
   You can connect multiple 1-wire slave devices to single bus.

1. Find and fix address of your 1-wire slave device in ArduinoOWISP.ino
   source code and compile firmware  
   ```byte addr[8] = {0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55};```  
   Note: this is just a default value for address, you can skip this step
   and set address later, see below.

1. Turn _local_ Arduino into "Arduino as ISP over 1-wire":  
   ```avrdude -P /dev/ttyUSB0 -c arduino -p m328p -U flash:w:ArduinoOWISP.hex```  

1. Burn firmware, EEPROM, change fuses on _remote_ Arduino as you usually do:  
   ```avrdude -P /dev/ttyUSB0 -b 19200 -c avrisp -p m328p -U flash:w:HelloWorld.hex```  
   Note: with ```-c avrisp``` avrdude communicates with ArduinoOWISP firmware
   on _local_ Arduino and affects _remote_ Arduino, while with ```-c arduino```
   avrdude communicates with bootloader on _local_ Arduino and affects
   _local_ Arduino.

## Set 1-wire address

There is no need to fix 1-wire slave address, recompile and burn ArduinoOWISP.hex
firmware each time address is changed. Current active address of 1-wire slave
is stored in RAM of _local_ Arduino and can be changed at any time by command:  
```echo -n '[2041420f484e5949]' >/dev/ttyUSB0```  
Or you can open minicom:  
```minicom -D /dev/ttyUSB0 -b 19200```  
and type "[2041420f484e5949]" without quotes and without pressing Enter.

It's also possible to choose the pin to which 1-wire bus is connected to, and even
to scan 1-wire bus, see below.

## OWSerial support

There are Arduino [OWSerial](https://github.com/honechko/DS2450/tree/main/Arduino/examples/OWSerial)
and similar C [owio](https://github.com/honechko/DS2450/tree/main/Arduino/examples/OWSerial/C/owio)
libraries intended for use on _remote_ Arduino that require special code
(OWSerialMaster) on _local_ Arduino in order to work. ArduinoOWISP has
built-in functionality of OWSerialMaster, which can be activated by sending
CR (Enter or Ctrl+M) in minicom or other serial communication program.
Current active address of 1-wire slave is used as target to open OWSerial/owio
connection to as well as for in-circuit programming. ArduinoOWISP
automatically exits from OWSerialMaster mode on receiving any command from
avrdude (more pecisely, on receiving sync sequence from avrdude).

## Examples

* Set 1-wire salve address of target:  
  ```echo -n '[2041420f484e5949]' >/dev/ttyUSB0```

* Upload firmware to target:  
  ```avrdude -P /dev/ttyUSB0 -b 19200 -c avrisp -p m328p -U flash:w:Echo.hex```

* Open bidirectional channel with OWSerial/owio library on target:  
  ```minicom -D /dev/ttyUSB0 -b 19200```  
  In opened minicom press Enter or Ctrl+M to activate connection. Exit
  from minicom as usual to close connection.

You can repeat above commands in any order and as many times as required.

## Serial commands

In minicom or other serial communication program ArduinoOWISP accepts the
next sequences:

* ```[2041420f484e5949]``` where 2041420f484e5949 is exactly 16 hexadecimal
  digits that represent 1-wire slave address, which becomes active.

* ```#07``` where 07 is exactly 2 decimal digits that represent Arduino pin
  number to which 1-wire bus is connected to, and which becomes active.

* ```?``` scans currently active 1-wire bus and shows its pin number and
  marks currently active 1-wire address in list. Mark '<' at end of address
  means that address is present on bus, mark '?' means that address was not
  found during scan.

* CR (Enter or Ctrl+M, symbol ```\r``` in echo command) activates
  bidirectional OWSerial/owio communication with target and relays data
  between target and serial communication program. ArduinoOWISP scans input
  from its serial port for special character sequence and closes OWSerial/owio
  connection and returns to normal mode if sequence was found. This sequence
  is normally generated by avrdude.

* ```!``` disables behaviour described above, subsequent CR will activate
  nonbreakable OWSerial/owio channel with target. The only way to break
  connection is reset of ArduinoOWISP.

## Nesting

Since avrdude communicates with ArduinoOWISP over serial link, is it possible
to emulate serial link by OWSerial for ArduinoOWISP code that runs on _target_
and to burn with it other _subtarget_ on nested 1-wire bus, conected to
_target_?  
Yes, it's possible.

Compile ArduinoOWISP firmware with uncommented line ```#define USE_OWSERIAL```,
burn it to _target_, run command:  
```echo -ne '#09[2041420F484E5949]!\r#02[2043420F484E5927]' >/dev/ttyUSB0```  
Where "#09[2041420F484E5949]" are bus and address of _target_,
"#02[2043420F484E5927]" are bus and address of _subtarget_. Serial connection
with _target_ will be unbreakable, all subsequent avrdude calls will be
redirected to ArduinoOWISP on _target_ and will affect _subtarget_.

More deep nesting is also possible.

